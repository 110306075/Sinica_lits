import numpy as np, pandas as pd, cv2
from pathlib import Path
from PIL import Image
from sklearn.model_selection import KFold
from fastai.vision.all import *


N_FOLDS = 5

def build_metadata(img_dir='./train_images', mask_dir='./train_masks',
                   n_folds=N_FOLDS, seed=42,filter_tumor_size_path=None):
    
    img_dir, mask_dir = Path(img_dir), Path(mask_dir)
    imgs  = sorted(img_dir.glob('*.jpg'))
    # print(imgs[0].stem)
    


    if filter_tumor_size_path:
        with open(filter_tumor_size_path, 'r') as f:
            valid_keywords = set(line.strip() for line in f)
        print(len(valid_keywords))
        imgs = [img for img in imgs if img.stem in valid_keywords]


    # img_dir, mask_dir = Path(img_dir), Path(mask_dir)
    # imgs  = sorted(img_dir.glob('*.jpg'))
    masks = [mask_dir/f'{p.stem}_mask.png' for p in imgs]

    df = pd.DataFrame({'image': imgs, 'mask': masks})
    print("shape of training data",df.shape)



build_metadata(filter_tumor_size_path='./small_tumor_slices.txt')